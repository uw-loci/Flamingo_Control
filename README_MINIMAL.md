# Flamingo Control - Minimal Interface

This is a minimal working interface for the Flamingo microscope control system, created during restructuring to provide basic workflow sending functionality.

## Features

✅ TCP/IP connection to Flamingo microscope
✅ Send workflow files (.txt) to microscope
✅ Stop workflow command
✅ Simple PyQt5 GUI
✅ Workflow file preview
✅ Connection status monitoring

## Setup

### 1. Create Virtual Environment

```bash
python3 -m venv .venv
source .venv/bin/activate  # On Linux/Mac
# or
.venv\Scripts\activate  # On Windows
```

### 2. Install Dependencies

```bash
pip install -r requirements-minimal.txt
```

This installs:
- PyQt5 (GUI framework)
- numpy (data handling)

### 3. Configuration

You need two things before connecting:

1. **FlamingoMetaData.txt** - Contains the microscope IP and port
   - Location: `microscope_settings/FlamingoMetaData.txt`
   - Generated by the Flamingo system during a workflow
   - Example line: `Microscope address = 10.129.37.22 53717`

2. **Workflow files** - XML-like text files defining acquisition parameters
   - Location: `workflows/*.txt`
   - Examples provided: `ZStack.txt`, `Snapshot.txt`

## Running

### Option 1: Shell Script (Linux/Mac)

```bash
./run_minimal.sh
```

### Option 2: Manual

```bash
source .venv/bin/activate
export PYTHONPATH="${PYTHONPATH}:$(pwd)/src"
cd src
python -m py2flamingo.minimal_gui
```

### Option 3: Direct Python

```bash
.venv/bin/python src/py2flamingo/minimal_gui.py
```

## Usage

### Connecting to the Microscope

1. **Load Metadata** (automatic on startup if file exists):
   - Click "Browse..." next to "Metadata File"
   - Select `microscope_settings/FlamingoMetaData.txt`
   - Click "Load" - this will populate IP and Port

2. **Or manually enter**:
   - IP Address: e.g., `10.129.37.22`
   - Port: e.g., `53717` (default Flamingo command port)

3. **Click "Connect"**:
   - Establishes connection on two ports:
     - Command port (specified port)
     - Live imaging port (port + 1)
   - Status will change to green "Connected" if successful

### Sending a Workflow

1. **Select workflow directory** (default: `workflows/`)
   - Click "Refresh" to scan for `.txt` files

2. **Choose a workflow** from the dropdown:
   - Preview appears in the text box below

3. **Click "Send Workflow"**:
   - Sends the workflow file to the microscope
   - Microscope will begin executing the workflow

4. **To stop**: Click "Stop Workflow"

## How It Works

### TCP Protocol

The Flamingo microscope uses a binary TCP protocol:

- **Command Structure** (128 bytes):
  - Start marker: `0xF321E654`
  - Command code: uint32
  - Status: uint32
  - 7× uint32 fields
  - 1× double (position value)
  - 1× uint32 (data bits)
  - 72 bytes data field
  - End marker: `0xFEDC4321`

### Workflow Sending

1. Send command header with:
   - Command: `12292` (CAMERA_WORK_FLOW_START)
   - Data field contains workflow file size

2. Follow with workflow file contents as UTF-8 text

### Key Files

- `src/py2flamingo/tcp_client.py` - TCP communication layer
- `src/py2flamingo/minimal_gui.py` - PyQt5 GUI application
- `src/py2flamingo/__init__.py` - Minimal package initialization

## Command Codes

From `command_list.txt`:

- `4105` - SCOPE_SETTINGS_LOAD
- `12292` - CAMERA_WORK_FLOW_START
- `12293` - CAMERA_WORK_FLOW_STOP
- `24580` - STAGE_POSITION_SET
- `24584` - STAGE_POSITION_GET
- `40962` - SYSTEM_STATE_IDLE
- `40967` - SYSTEM_STATE_GET

## Workflow File Format

Workflows are XML-like text files with sections:

```xml
<Workflow Settings>
  <Experiment Settings>
    Plane spacing (um) = 10
    Frame rate (f/s) = 40.003200
    ...
  </Experiment Settings>
  <Stack Settings>
    Number of planes = 1
    Change in Z axis (mm) = 0.01
    ...
  </Stack Settings>
  <Start Position>
    X (mm) = 13.37
    Y (mm) = 1.7
    Z (mm) = 13.7
    Angle (degrees) = 0
  </Start Position>
  <Illumination Source>
    Laser 3 488 nm = 0.00 0
    LED_RGB_Board = 38.04 1
    ...
  </Illumination Source>
</Workflow Settings>
```

## Troubleshooting

### Cannot connect

- Verify microscope is powered on
- Check network connection (VPN if remote)
- Confirm IP address in metadata file is correct
- Ensure firewall allows connections on ports 53717-53718

### Import errors

```bash
# Make sure you're in the virtual environment
source .venv/bin/activate

# Verify packages installed
pip list | grep PyQt5
```

### No workflows found

- Check `workflows/` directory exists
- Ensure it contains `.txt` files
- Click "Browse..." to select a different directory

### Workflow doesn't execute

- Check microscope logs (if accessible)
- Verify workflow file format is correct
- Some firmware versions may not support all workflow features

## Development

### Testing without hardware

See `tests/mock_microscope_server.py` for a mock server that simulates the microscope for testing.

```bash
# Terminal 1: Start mock server
python tests/mock_microscope_server.py

# Terminal 2: Run GUI, connect to 127.0.0.1:53717
./run_minimal.sh
```

### Adding features

The minimal interface is designed to be extended:

- Add new commands in `tcp_client.py`
- Add UI controls in `minimal_gui.py`
- Workflow files can be edited in any text editor

## What's NOT included

This minimal interface intentionally omits:

- ❌ Napari integration
- ❌ Image display/viewing
- ❌ Sample search/positioning
- ❌ Multi-angle acquisition
- ❌ Ellipse tracing
- ❌ Complex threading/queue management
- ❌ Settings persistence

These features exist in the full (pre-restructure) codebase but are being refactored.

## Restoring Full Functionality

The original `__init__.py` has been backed up as `__init__.py.backup`. To restore:

```bash
cp src/py2flamingo/__init__.py.backup src/py2flamingo/__init__.py
```

Note: This will require additional dependencies (scipy, etc.) and the full codebase.

## Next Steps

1. Test with real microscope hardware
2. Verify workflow execution completes
3. Add position control commands
4. Implement image data receiving on live port
5. Gradually restore other features as refactoring progresses

## License

See LICENSE file in repository root.

## Support

For issues with the minimal interface, check:
- Log output in the GUI
- Connection status indicators
- Microscope firmware version (requires v2.16.2)

For full Flamingo documentation, see the main README.md and CLAUDE.md files.
